<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Bidirectional Highlighting with Draggable Divider</title>
    <style>
        body { 
            display: flex; 
            font-family: monospace; 
            margin: 0; 
            padding: 0; 
            height: 100vh; 
            overflow: hidden;
        }
        .editor-container {
            display: flex;
            width: 100%;
            height: 100%;
        }
        .editor { 
            height: 100%; 
            overflow-y: auto; 
            border: 1px solid #ddd; 
            padding: 10px; 
            box-sizing: border-box;
        }
        .line { 
            padding: 2px 5px; 
            cursor: pointer; 
        }
        .highlight { 
            background-color: yellow; 
        }
        .line-number { 
            color: #888; 
            display: inline-block; 
            width: 30px; 
            text-align: right; 
            margin-right: 10px; 
        }
        .mapped-line {
            font-weight: bold;
        }
        .divider {
            width: 10px;
            background-color: #ccc;
            cursor: col-resize;
        }
    </style>
</head>
<body>
    <div class="editor-container">
        <div id="fxGraph" class="editor"></div>
        <div id="divider" class="divider"></div>
        <div id="generatedCode" class="editor"></div>
    </div>
    <script src="data.js"></script>

    <script>


        function highlightLines(sourceEditor, targetEditor, mapping, lineNumber) {
            targetEditor.querySelectorAll('.highlight').forEach(el => el.classList.remove('highlight'));
            const correspondingLines = mapping[lineNumber - 1] || [];
            correspondingLines.forEach(line => {
                const targetLine = targetEditor.children[line];
                if (targetLine) {
                    targetLine.classList.add('highlight');
                }
            });
        }

        function handleMouseMove(event, sourceEditor, targetEditor, mapping) {
            const target = event.target.closest('.line');
            if (target) {
                const lineNumber = Array.from(sourceEditor.children).indexOf(target) + 1;
                highlightLines(sourceEditor, targetEditor, mapping, lineNumber);
            }
        }

        function handleClick(event, sourceEditor, targetEditor, mapping) {
            const target = event.target.closest('.line');
            if (target) {
                const lineNumber = Array.from(sourceEditor.children).indexOf(target) + 1;
                const correspondingLines = mapping[lineNumber - 1] || [];
                if (correspondingLines.length > 0) {
                    const firstCorrespondingLine = correspondingLines[0];
                    const targetLine = targetEditor.children[firstCorrespondingLine - 1];
                    if (targetLine) {
                        targetLine.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        highlightLines(sourceEditor, targetEditor, mapping, lineNumber);
                    }
                }
            }
        }

        const fxGraphData = getGraph();
        const codeData = getCode();
        const { leftToRight, rightToLeft } = computeSourceMaps(fxGraphData, codeData);
        console.log(leftToRight, rightToLeft);

        const fxGraph = document.getElementById('fxGraph');
        const generatedCode = document.getElementById('generatedCode');
        const divider = document.getElementById('divider');

        // Function to set initial editor widths
        function setInitialEditorWidths() {
            const containerWidth = document.querySelector('.editor-container').offsetWidth;
            const editorWidth = (containerWidth - divider.offsetWidth) / 2;
            fxGraph.style.width = `${editorWidth}px`;
            generatedCode.style.width = `${editorWidth}px`;
        }

        // Call this function when the page loads
        window.addEventListener('load', setInitialEditorWidths);

        // Also call it when the window is resized
        window.addEventListener('resize', setInitialEditorWidths);

        fxGraphData.forEach((line, index) => {
            const div = document.createElement('div');
            div.className = 'line';
            div.innerHTML = `<span class="line-number">${index + 1}</span>${line}`;
            fxGraph.appendChild(div);
        });

        codeData.forEach((line, index) => {
            const div = document.createElement('div');
            div.className = 'line';
            div.innerHTML = `<span class="line-number">${index + 1}</span>${line}`;
            generatedCode.appendChild(div);
        });

        function populateEditor(editor, data, mapping) {
            editor.innerHTML = '';
            data.forEach((line, index) => {
                const div = document.createElement('div');
                div.className = 'line';
                if (mapping[index] && mapping[index].length > 0) {
                    div.classList.add('mapped-line');
                }
                div.innerHTML = `<span class="line-number">${index + 1}</span>${line}`;
                editor.appendChild(div);
            });
        }

        // Populate editors with shading
        populateEditor(fxGraph, fxGraphData, leftToRight);
        populateEditor(generatedCode, codeData, rightToLeft);

        // Modify the draggable functionality
        let isDragging = false;
        let startX, startLeftWidth;

        divider.addEventListener('mousedown', (e) => {
            isDragging = true;
            startX = e.clientX;
            startLeftWidth = fxGraph.offsetWidth;
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const dx = e.clientX - startX;
            const newLeftWidth = startLeftWidth + dx;
            const containerWidth = document.querySelector('.editor-container').offsetWidth;
            
            if (newLeftWidth > 100 && newLeftWidth < containerWidth - 100) {
                fxGraph.style.width = `${newLeftWidth}px`;
                generatedCode.style.width = `${containerWidth - newLeftWidth - divider.offsetWidth}px`;
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
        });


        // Event listeners for highlighting and scrolling
        fxGraph.addEventListener('mousemove', (event) => handleMouseMove(event, fxGraph, generatedCode, leftToRight));
        generatedCode.addEventListener('mousemove', (event) => handleMouseMove(event, generatedCode, fxGraph, rightToLeft));

        fxGraph.addEventListener('click', (event) => handleClick(event, fxGraph, generatedCode, leftToRight));
        generatedCode.addEventListener('click', (event) => handleClick(event, generatedCode, fxGraph, rightToLeft));

        fxGraph.addEventListener('mouseout', () => generatedCode.querySelectorAll('.highlight').forEach(el => el.classList.remove('highlight')));
        generatedCode.addEventListener('mouseout', () => fxGraph.querySelectorAll('.highlight').forEach(el => el.classList.remove('highlight')));
    </script>
</body>
</html>